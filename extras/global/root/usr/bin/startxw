#!/bin/sh

# usage: startxw SESSION [-- ARGS...]
# SESSION         seesion to start if not specified run interactive mode
# ARGS...         startx arguments

XSESSION_LOGS_DIR="${XSESSION_LOGS_DIR:-"$XDG_CACHE_HOME/xsessionlogs"}"
XSESSION_LOGS_HISTORY="${XSESSION_LOGS_HISTORY:-5}"
STARTXW_EXEC_DIR="${STARTXW_EXEC_DIR:-$HOME}"
ENABLED_SESSIONS="${ENABLED_SESSIONS:-"i3 xmonad bspwm dwm awesome xfce"}"
#shellcheck disable=SC2086
_available_sessions="$(command -V $ENABLED_SESSIONS 2> /dev/null | grep -v "not found" | cut -d' ' -f1)"

_args="$*"
_wrapper_args="${_args%% -- *}"
_startx_args="${_args#* -- }"

_choice="${_wrapper_args:-}"

if [ -z "$_choice" ]; then
  trap 'exit 1' INT
  echo "Available sessions:"
  echo "$_available_sessions" | awk '{print "  " NR ") " $0}'
  printf "Select name or number (defaut 1): "
  read -r _choice </dev/tty
  _choice="${_choice:-1}"
  trap - INT
fi
if test "$_choice" -gt 0 2>/dev/null; then
  _xsession="$(echo "$_available_sessions" | awk "NR == $_choice")"
else
  _xsession="$(echo "$_available_sessions" | grep -Eo "^$_choice$")"
fi

[ "$(echo "$_xsession" | wc -l)" -ne 1 ] && echo "Ambigous selection matched:" && echo "$_xsession" && exit 1
[ -z "$_xsession" ] && echo "Bad session: '$_choice'!" && exit 1;

# logging
_log_file="$XSESSION_LOGS_DIR/$(date +'%F_%H-%M-%S').log"
mkdir -p "$XSESSION_LOGS_DIR"
find "$XSESSION_LOGS_DIR" -type f -printf "%T@:%p\n" | sort -nr | tail -n "+$XSESSION_LOGS_HISTORY" | cut -d: -f2- |
  xargs -r rm || true # remove old logs
ln -sf "$_log_file" "$XSESSION_LOGS_DIR/current.log" # select log file

echo "Starting_session: $_xsession"
_cwd="$PWD"
cd "$STARTXW_EXEC_DIR" || exit 5
DESKTOP_SESSION="$_xsession" exec startx "$_startx_args" 2>&1 | ts '[%Y-%m-%d %H:%M:%S]' > "$_log_file" 2>&1
cd "$_cwd" || exit 5
