#!/bin/sh

# Check dependencies
for cmd in git fzf; do
  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo "Error: $cmd is not installed." >&2
    exit 1
  fi
done

# Ensure we're in a git repo
if ! git rev-parse --git-dir >/dev/null 2>&1; then
  echo "Error: Not a git repository." >&2
  exit 1
fi

# Get sorted list of branches (local and remote) by last commit date
#BRANCHES=$(git for-each-ref --sort=-committerdate --format='%(refname:short)' refs/heads refs/remotes)
BRANCHES=$(git for-each-ref --sort=-committerdate --format='%(refname:short)' refs/heads)

_preview='git log --color=always --graph --pretty="%Cred%h%Creset -%C(auto)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset"'
# Use fzf to select a branch with a commit preview
SELECTED=$(echo "$BRANCHES" | fzf \
  --ansi \
  --prompt="git checkout: " \
  --preview="$_preview {}" \
  --preview-window="right:70%")
  #--preview="git log --color=always -n 5 {}")

# Exit if no branch was selected
[ -z "$SELECTED" ] && echo "No branch selected." && exit 0

# Checkout logic
if echo "$SELECTED" | grep -q '^remotes/'; then
  BRANCH_NAME=$(echo "$SELECTED" | sed 's|remotes/[^/]*/||')
  git checkout -t "$SELECTED"
else
  git checkout "$SELECTED"
fi
